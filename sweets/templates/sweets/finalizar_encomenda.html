{% extends "sweets/base_corrigido_final.html" %}

{% block title %}Finalizar Encomenda - iv_Sweets{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    Finalizar Encomenda
                </h1>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Resumo do Carrinho</h5>
                    </div>
                    <div class="card-body">
                        {% for item in itens %}
                            <div class="row align-items-center mb-3 pb-3 border-bottom">
                                <div class="col-md-2">
                                    {% if item.produto.imagem %}
                                        <img src="{{ item.produto.imagem.url }}" class="img-fluid rounded" alt="{{ item.produto.nome }}" style="max-width: 80px;">
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <h6>{{ item.produto.nome }}</h6>
                                    <p class="text-dark small mb-0">{{ item.produto.categoria.nome }}</p>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-secondary">Qtd: {{ item.quantidade }}</span>
                                </div>
                                <div class="col-md-2">
                                    <strong class="price-tag">{{ item.subtotal }} MT</strong>
                                </div>
                            </div>
                        {% endfor %}

                        <div class="row">
                            <div class="col-md-8">
                                <h4>Total: <span class="price-tag">{{ total }} MT</span></h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detalhes da Encomenda -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Detalhes da Encomenda</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição da Encomenda *</label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="4"
                                      placeholder="Descreva como gostaria que o bolo fosse feito. Inclua detalhes sobre o design, cores, sabores especiais, inscrições, etc." required></textarea>
                            <div class="form-text">Seja específico sobre como quer seu bolo personalizado.</div>
                        </div>

                        <!-- Imagens de Referência -->
                        <div class="mb-3">
                            <label class="form-label">Imagens de Referência (Opcional - Máximo 2 imagens)</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="imagem_referencia_1" class="form-label">Imagem 1</label>
                                    <input type="file" class="form-control" id="imagem_referencia_1" name="imagem_referencia_1"
                                           accept="image/*">
                                    <div class="form-text">Envie uma foto de exemplo ou inspiração para o design do bolo.</div>
                                    <div class="mt-2" id="preview1" style="display: none;">
                                        <img id="previewImg1" src="" alt="Pré-visualização" class="img-fluid rounded shadow" style="max-width: 100%; max-height: 200px;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="imagem_referencia_2" class="form-label">Imagem 2</label>
                                    <input type="file" class="form-control" id="imagem_referencia_2" name="imagem_referencia_2"
                                           accept="image/*">
                                    <div class="form-text">Segunda imagem opcional para mais referências.</div>
                                    <div class="mt-2" id="preview2" style="display: none;">
                                        <img id="previewImg2" src="" alt="Pré-visualização" class="img-fluid rounded shadow" style="max-width: 100%; max-height: 200px;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Você pode enviar até 2 imagens mostrando como gostaria que o bolo fosse. Pode ser fotos de bolos que gostou, desenhos, ou qualquer referência visual.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="data_recepcao" class="form-label">Data de Recepção Desejada *</label>
                            <input type="date" class="form-control" id="data_recepcao" name="data_recepcao"
                                   min="{% now 'Y-m-d' %}" required>
                            <div class="form-text">Selecione a data em que deseja receber sua encomenda.</div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Pagamento -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Informações de Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" id="orderForm">
                            {% csrf_token %}

                            <div class="mb-3">
                                <label for="metodo_pagamento" class="form-label">Método de Pagamento *</label>
                                <select class="form-select" id="metodo_pagamento" name="metodo_pagamento" required>
                                    <option value="">Selecione o método de pagamento</option>
                                    <option value="emola">E-MOLA</option>
                                    <option value="mpesa">M-PESA</option>
                                    <option value="bim">BIM</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="numero_referencia" class="form-label">Número de Referência *</label>
                                <input type="text" class="form-control" id="numero_referencia" name="numero_referencia"
                                       placeholder="Digite o número de referência do pagamento" required>
                                <div class="form-text">Número de transação ou referência do pagamento</div>
                            </div>

                            <div class="mb-3">
                                <label for="comprovativo" class="form-label">Comprovativo de Pagamento *</label>
                                <input type="file" class="form-control" id="comprovativo" name="comprovativo"
                                       accept="image/*,.pdf" required>
                                <div class="form-text">Envie uma imagem ou PDF do comprovativo (máx. 10MB)</div>
                            </div>

                            <div class="mb-3">
                                <label for="observacoes" class="form-label">Observações</label>
                                <textarea class="form-control" id="observacoes" name="observacoes"
                                          rows="3" placeholder="Adicione observações sobre o pagamento (opcional)"></textarea>
                                <div class="form-text">Adicione qualquer informação adicional sobre o pagamento</div>
                            </div>

                            <!-- Image Preview -->
                            <div class="mb-3" id="imagePreview" style="display: none;">
                                <label class="form-label">Pré-visualização do Comprovativo:</label>
                                <div class="card">
                                    <div class="card-body text-center">
                                        <img id="previewImg" src="" alt="Pré-visualização" class="img-fluid rounded shadow" style="max-width: 100%; max-height: 300px;">
                                        <p class="mt-2 mb-0"><small class="text-muted">Imagem carregada com sucesso!</small></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações de Pagamento por Método -->
                            <div id="paymentInfo" class="alert alert-info" style="display: none;">
                                <h6>Como efetuar o pagamento:</h6>
                                <div id="paymentInstructions"></div>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Informações Importantes:</h6>
                                <ul class="mb-0">
                                    <li>O administrador será notificado automaticamente após o envio</li>
                                    <li>Você pode acompanhar o status da encomenda em "Minhas Encomendas"</li>
                                    <li>Certifique-se de que todos os dados estão corretos antes de enviar</li>
                                </ul>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'sweets:carrinho' %}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-arrow-left"></i> Voltar ao Carrinho
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-paper-plane"></i> Enviar Encomenda e Pagamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Instruções de Pagamento -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Instruções de Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="paymentAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingEmola">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmola">
                                        <strong>E-MOLA</strong>
                                    </button>
                                </h2>
                                <div id="collapseEmola" class="accordion-collapse collapse" data-bs-parent="#paymentAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Para pagar via E-MOLA:</strong></p>
                                        <ol>
                                            <li>Abra o aplicativo E-MOLA no seu telemóvel</li>
                                            <li>Selecione "Pagar" ou "Transferir"</li>
                                            <li>Digite o número: <strong>87 591 4693</strong></li>
                                            <li>Insira o valor: <strong>{{ total }} MT</strong></li>
                                            <li>Na referência, digite: <strong>ENCOMENDA-NOVA</strong></li>
                                            <li>Confirme o pagamento</li>
                                            <li>Tire uma captura de ecrã do comprovativo</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingMpesa">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMpesa">
                                        <strong>M-PESA</strong>
                                    </button>
                                </h2>
                                <div id="collapseMpesa" class="accordion-collapse collapse" data-bs-parent="#paymentAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Para pagar via M-PESA:</strong></p>
                                        <ol>
                                            <li>Abra o aplicativo M-PESA no seu telemóvel</li>
                                            <li>Selecione "Pagar" ou "Transferir para Número"</li>
                                            <li>Digite o número: <strong>85 813 4018</strong></li>
                                            <li>Insira o valor: <strong>{{ total }} MT</strong></li>
                                            <li>Na referência, digite: <strong>ENCOMENDA-NOVA</strong></li>
                                            <li>Confirme o pagamento</li>
                                            <li>Tire uma captura de ecrã do comprovativo</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingBIM">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBIM">
                                        <strong>BIM (Transferência Bancária)</strong>
                                    </button>
                                </h2>
                            <div id="collapseBIM" class="accordion-collapse collapse" data-bs-parent="#paymentAccordion">
                                <div class="accordion-body">
                                    <p><strong>Para pagar via Transferência Bancária:</strong></p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Banco:</strong> BIM</p>
                                            <p><strong>Número da Conta:</strong> 1209195793</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Titular:</strong> IVONETE NAITE MUZORORA</p>
                                            <p><strong>Valor:</strong> {{ total }} MT</p>
                                        </div>
                                    </div>
                                    <p><strong>Referência:</strong> ENCOMENDA-NOVA</p>
                                    <p><small class="text-muted">Envie o comprovativo da transferência bancária</small></p>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Set minimum date to tomorrow
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('data_recepcao').setAttribute('min', minDate);
});

// Payment method selection
document.getElementById('metodo_pagamento').addEventListener('change', function() {
    const metodo = this.value;
    const paymentInfo = document.getElementById('paymentInfo');
    const paymentInstructions = document.getElementById('paymentInstructions');

    if (metodo) {
        paymentInfo.style.display = 'block';

        switch(metodo) {
            case 'emola':
                paymentInstructions.innerHTML = `
                    <p><strong>Pagamento via E-MOLA:</strong></p>
                    <ul>
                        <li>Número: <strong>87 591 4693</strong></li>
                        <li>Valor: <strong>{{ total }} MT</strong></li>
                        <li>Referência: <strong>ENCOMENDA-NOVA</strong></li>
                    </ul>
                `;
                break;
            case 'mpesa':
                paymentInstructions.innerHTML = `
                    <p><strong>Pagamento via M-PESA:</strong></p>
                    <ul>
                        <li>Número: <strong>85 813 4018</strong></li>
                        <li>Valor: <strong>{{ total }} MT</strong></li>
                        <li>Referência: <strong>ENCOMENDA-NOVA</strong></li>
                    </ul>
                `;
                break;
            case 'bim':
                paymentInstructions.innerHTML = `
                    <p><strong>Transferência Bancária - BIM:</strong></p>
                    <ul>
                        <li>Banco: BIM</li>
                        <li>Conta: 1209195793</li>
                        <li>Valor: <strong>{{ total }} MT</strong></li>
                        <li>Referência: <strong>ENCOMENDA-NOVA</strong></li>
                    </ul>
                `;
                break;
        }
    } else {
        paymentInfo.style.display = 'none';
    }
});

// Image preview functionality for payment proof
document.getElementById('comprovativo').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');

    if (file) {
        // Check if file is an image
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            // Hide preview if not an image
            imagePreview.style.display = 'none';
            alert('Por favor, selecione uma imagem válida.');
        }
    } else {
        imagePreview.style.display = 'none';
    }
});

// Image preview functionality for reference images
document.getElementById('imagem_referencia_1').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('preview1');
    const previewImg = document.getElementById('previewImg1');

    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
        if (file) {
            alert('Por favor, selecione uma imagem válida para a referência 1.');
        }
    }
});

document.getElementById('imagem_referencia_2').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('preview2');
    const previewImg = document.getElementById('previewImg2');

    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
        if (file) {
            alert('Por favor, selecione uma imagem válida para a referência 2.');
        }
    }
});
</script>
{% endblock %}
